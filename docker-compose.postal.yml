# Postal Mail Server - Self-hosted email delivery
#
# This runs Postal alongside Pulsar for production email delivery.
#
# Prerequisites:
# 1. DNS records configured for your mail domain:
#    - A record: postal.yourdomain.com -> your server IP
#    - MX record: yourdomain.com -> postal.yourdomain.com
#    - SPF record: v=spf1 a mx include:postal.yourdomain.com ~all
#    - DKIM: Will be generated by Postal
#
# 2. Create .env.postal with:
#    POSTAL_DOMAIN=postal.yourdomain.com
#    POSTAL_WEB_HOST=postal.yourdomain.com
#    MYSQL_ROOT_PASSWORD=secure_password_here
#    POSTAL_SMTP_USERNAME=pulsar
#    POSTAL_SMTP_PASSWORD=your_smtp_password
#
# 3. Initialize Postal:
#    docker-compose -f docker-compose.postal.yml run --rm postal initialize
#    docker-compose -f docker-compose.postal.yml run --rm postal make-user
#
# 4. Start services:
#    docker-compose -f docker-compose.postal.yml up -d
#
# 5. Configure Pulsar's .env:
#    SMTP_HOST=postal-smtp
#    SMTP_PORT=25
#    SMTP_USERNAME=pulsar@yourdomain.com
#    SMTP_PASSWORD=your_smtp_password
#    SMTP_FROM=noreply@yourdomain.com

services:
  postal-mariadb:
    image: mariadb:10.6
    container_name: postal-mariadb
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: postal
    volumes:
      - postal_mysql_data:/var/lib/mysql
    networks:
      - postal-network
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5

  postal-rabbitmq:
    image: rabbitmq:3.12-alpine
    container_name: postal-rabbitmq
    restart: unless-stopped
    environment:
      RABBITMQ_DEFAULT_USER: postal
      RABBITMQ_DEFAULT_PASS: postal
    volumes:
      - postal_rabbitmq_data:/var/lib/rabbitmq
    networks:
      - postal-network
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 10s
      timeout: 5s
      retries: 5

  postal:
    image: ghcr.io/postalserver/postal:latest
    container_name: postal-web
    restart: unless-stopped
    depends_on:
      postal-mariadb:
        condition: service_healthy
      postal-rabbitmq:
        condition: service_healthy
    environment:
      POSTAL_FNAME: Postal
      POSTAL_LNAME: Admin
      POSTAL_EMAIL: admin@${POSTAL_DOMAIN}
      MAIN_DB_HOST: postal-mariadb
      MAIN_DB_PORT: 3306
      MAIN_DB_USERNAME: root
      MAIN_DB_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MAIN_DB_NAME: postal
      MESSAGE_DB_HOST: postal-mariadb
      MESSAGE_DB_PORT: 3306
      MESSAGE_DB_USERNAME: root
      MESSAGE_DB_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      RABBITMQ_HOST: postal-rabbitmq
      RABBITMQ_USERNAME: postal
      RABBITMQ_PASSWORD: postal
      POSTAL_WEB_HOST: ${POSTAL_WEB_HOST}
      POSTAL_WEB_PROTOCOL: https
      POSTAL_SMTP_HOST: ${POSTAL_DOMAIN}
      RAILS_SECRET_KEY: ${POSTAL_SECRET_KEY:-change_this_to_a_random_64_char_string}
    volumes:
      - postal_config:/config
      - postal_assets:/opt/postal/public/assets
    networks:
      - postal-network
      - pulsar-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.postal.rule=Host(`${POSTAL_WEB_HOST}`)"
      - "traefik.http.routers.postal.entrypoints=websecure"
      - "traefik.http.routers.postal.tls.certresolver=letsencrypt"
      - "traefik.http.services.postal.loadbalancer.server.port=5000"

  postal-smtp:
    image: ghcr.io/postalserver/postal:latest
    container_name: postal-smtp
    restart: unless-stopped
    command: postal smtp-server
    depends_on:
      - postal
    environment:
      MAIN_DB_HOST: postal-mariadb
      MAIN_DB_PORT: 3306
      MAIN_DB_USERNAME: root
      MAIN_DB_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MAIN_DB_NAME: postal
      MESSAGE_DB_HOST: postal-mariadb
      MESSAGE_DB_PORT: 3306
      MESSAGE_DB_USERNAME: root
      MESSAGE_DB_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      RABBITMQ_HOST: postal-rabbitmq
      RABBITMQ_USERNAME: postal
      RABBITMQ_PASSWORD: postal
    ports:
      - "25:25"
      - "587:587"
    volumes:
      - postal_config:/config
    networks:
      - postal-network
      - pulsar-network

  postal-worker:
    image: ghcr.io/postalserver/postal:latest
    container_name: postal-worker
    restart: unless-stopped
    command: postal worker
    depends_on:
      - postal
    environment:
      MAIN_DB_HOST: postal-mariadb
      MAIN_DB_PORT: 3306
      MAIN_DB_USERNAME: root
      MAIN_DB_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MAIN_DB_NAME: postal
      MESSAGE_DB_HOST: postal-mariadb
      MESSAGE_DB_PORT: 3306
      MESSAGE_DB_USERNAME: root
      MESSAGE_DB_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      RABBITMQ_HOST: postal-rabbitmq
      RABBITMQ_USERNAME: postal
      RABBITMQ_PASSWORD: postal
    volumes:
      - postal_config:/config
    networks:
      - postal-network

volumes:
  postal_mysql_data:
  postal_rabbitmq_data:
  postal_config:
  postal_assets:

networks:
  postal-network:
    driver: bridge
  pulsar-network:
    external: true
